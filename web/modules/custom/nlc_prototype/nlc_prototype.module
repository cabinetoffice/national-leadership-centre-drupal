<?php

use Drupal\Core\Cache\RefinableCacheableDependencyInterface;
use Drupal\user\UserInterface;

/**
 * Implements hook_mail().
 */
function nlc_prototype_mail($key, &$message, $params) {
  switch ($key) {
    case 'directory_access_token':
      $message['from'] = \Drupal::config('system.site')->get('mail');
      $message['subject'] = t('Access link: Senior Leader directory');
      $message['body'] = $params['message'];
      break;
  }
}

/**
 * Implements hook_menu_local_tasks_alter().
 */
function nlc_prototype_menu_local_tasks_alter(&$data, $route_name, RefinableCacheableDependencyInterface &$cacheability) {
  $account = \Drupal::currentUser();
  $roles = $account->getRoles();
  $these_roles = ['authenticated'];
  if (empty(array_diff($roles, $these_roles))) {
    $routes = [
      'entity.user.canonical',
      'entity.profile.type.user_profile_form',
    ];
    if (in_array($route_name, $routes)) {
      unset($data['tabs'][0]['entity.profile.user_profile_form:profile.type.role']);
    }
  }
}

/**
 * Implements hook_ENTITY_TYPE_presave for User entities.
 *
 * @param \Drupal\user\UserInterface $account
 */
function nlc_prototype_user_presave(UserInterface $account) {
  if ($account->get('field_first_name') && $account->get('field_last_name')) {
    $proper_name = $account->get('field_name')->getValue();
    $name = [
      'title' => $account->get('field_title')->getString(),
      'given' =>  $account->get('field_first_name')->getString(),
      'family' => $account->get('field_last_name')->getString(),
    ];
    $account->set('field_full_name', implode(' ', $name));
    $new_proper_name = array_merge($proper_name[0], $name);
    $account->set('field_name', $new_proper_name);
  }
}
